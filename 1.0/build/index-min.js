/*! albums - v1.0 - 2013-09-18 10:50:57 AM
* Copyright (c) 2013 hanwen.sah; Licensed  */
KISSY.add("gallery/albums/1.0/album-tpl",function(){return{html:'<div class="handers{{#if index === len - 1}} step-last{{/if}}{{#if index === 0}} step-start{{/if}}">\n  <span class="prev album-prev hander">&lt;</span>   \n  <span class="next album-next hander">&gt;</span>   \n</div>\n<div class="box">   \n  <div class="album-action-bar">\n    <a class="album-big action" data-action="zoom" href="#nowhere"></a>\n    <a class="album-small action" data-action="zoom" href="#nowhere"></a>\n    <a class="rotation-pro action" data-action="rotation-pro" href="#nowhere"></a>\n    <a class="rotation-con action" data-action="rotation-con" href="#nowhere"></a>\n  </div>\n  <div class="box-main album-loading" style="height: {{h - 20}}px">  \n    {{#if download}}\n      <a href="{{download}}"><img class="{{imgCls}}" src="{{src}}" alt="" /></a>\n    {{else}}\n      <img class="{{imgCls}}" src="{{src}}" style="display: none" alt="" />\n    {{/if}}\n  </div>   \n  <div class="box-aside" style="height: {{h}}px">   \n    <div class="aside-wrap">  \n      <div class="headline"><em class="J_num num">{{index + 1}}/{{len}}</em>{{title}}</div>  \n      {{#if desc}}\n      <p class="J_desc desc">{{prefix}}: {{{desc}}}</p>  \n      {{/if}}\n    </div>   \n  </div>   \n</div>\n'}}),KISSY.add("gallery/albums/1.0/dialog",function(a,b,c){function d(){f&&f.destroy(),f=new c.Draggable({node:g.all(".J_img"),move:!0})}function e(a){return function(b){var c=h.get("album-id");h.fire(a+":"+c,{el:b.currentTarget})}}var f,g,h=new a.Dialog({width:"100%",height:"100%",elCls:"albums-dialog"});h.on("show",function(){a.Event.on(window,"mousewheel",function(a){a.halt()}),a.all("html").css("overflow-y","hidden"),d()}),h.on("hide",function(){a.Event.detach(window,"mousewheel"),a.all("html").css("overflow-y","auto")}),h.on("change:step",d);var i={};return h.getWinHeight=function(){return i.height||(i.height=a.DOM.viewportHeight()),i.height},h.getWinWidth=function(){return i.width||(i.width=a.DOM.viewportWidth()),i.width},h.on("afterRenderUI",function(){g=h.get("contentEl"),g.delegate("click",".hander",e("hander")),g.delegate("click",".action",e("action")),a.Event.on(window,"resize",a.throttle(function(){if(h.get("visible")){var a=h.get("album-id");h.fire("resize:"+a),i={}}},100,this)),a.Event.on(document,"keyup",function(a){if(h.get("visible")){var b=h.get("album-id");39===a.keyCode?h.fire("next:"+b):37===a.keyCode&&h.fire("prev:"+b)}})}),h},{requires:["overlay","dd"]}),KISSY.add("gallery/albums/1.0/rotate",function(a){function b(b,e){var f={};return void 0===e&&(e=1),f=a.UA.ie&&a.UA.ie<9?c(b,e):d(b,e)}function c(b,c){b=b/180*Math.PI;var d=Math.cos(b)*c,e=Math.sin(b)*c,f=-Math.sin(b)*c,g="progid:DXImageTransform.Microsoft.Matrix(M11={costheta},M12={sinthetaN},M21={sintheta},M22={costheta},SizingMethod='auto expand')";return g=a.substitute(g,{costheta:d,sintheta:e,sinthetaN:f}),{filter:g}}function d(b,c){var d={"-moz-transform":"rotate({degree}deg) scale({scale})","-webkit-transform":"rotate({degree}deg) scale({scale})","-ms-transform":"rotate({degree}deg) scale({scale})","-o-transform":"rotate({degree}deg) scale({scale})",transform:"rotate({degree}deg) scale({scale})"};return a.each(d,function(e,f){d[f]=a.substitute(e,{degree:b,scale:c})}),d}return b}),KISSY.add("gallery/albums/1.0/index",function(a,b,c,d,e,f,g,h,i){function j(a){var b=this;j.superclass.constructor.call(b,a),b.init()}function k(a){if(a.prop("naturalWidth"))return{width:a.prop("naturalWidth"),height:a.prop("naturalHeight")};var b=new Image;return b.src=a.attr("src"),{width:b.width,height:b.height}}var l=b.all,m=new g(f.html);return a.extend(j,c,{init:function(){var a=this.get("baseEl");a.length&&(this.set("id",1),h.render(),this._bindEvent())},_setEls:function(){var a=this.get("baseEl"),b=l(this.get("img"),a);return b.each(function(a,b){a.attr("data-index",b)}),this.set("imgList",b),this.set("len",b.length),b},_bindEvent:function(){var b=this.get("baseEl"),c=this.get("trigger"),d=this.get("img");a.Event.delegate(b,c,d,this._show,this);var e=this.get("id");h.on("hander:"+e,this._go,this),h.on("action:"+e,this._action,this),h.on("resize:"+e,this._resize,this);var f=this;h.on("prev:"+e,function(){f.go(-1)}),h.on("next:"+e,function(){f.go(1)}),this.on("switch",this._hander,this)},_action:function(a){var b=a.el,c=l(b).attr("data-action");"rotation-con"==c?this._rotation(-90):"rotation-pro"==c?this._rotation(90):"zoom"==c&&this._zoom(l(b))},_rotation:function(a){var b=h.get("contentEl").all(".J_img"),c=this.get("rotation"),d=this.get("scale");c+=parseInt(a,10),this.set("rotation",c);var e=i(c,d);b.css(e)},_resize:function(){var a=h.get("contentEl").all(".J_img"),b=h.getWinHeight()-74-20;h.get("contentEl").all(".box-main").height(b-20),h.get("contentEl").all(".box-aside").height(b),this._position(a,!0)},_hander:function(a){var b=h.get("contentEl"),c=b.all(".hander");0===a.from&&c.removeClass("step-start"),0===a.to&&c.addClass("step-start");var d=this.get("len")-1;a.to===d&&c.addClass("step-last"),a.from===d&&c.removeClass("step-last")},_zoom:function(a){var b=h.get("contentEl").all(".J_img"),c=a.hasClass("album-big");if(c)this._zoomOut(b);else{var d=this.get("rotation"),e=this.get("zoomFit"),f=i(d,e);b.css(f),this.set("scale",e),this._position(b,!0)}},_zoomOut:function(a){var b=this.get("rotation"),c=this.get("scale");c+=.2,1>c&&(c=1);var d=i(b,c);a.css(d),this.set("scale",c)},_position:function(b,c){if(b.data("loaded")){var d=k(b),e=h.getWinHeight()-74-20,f=h.getWinWidth()-74-235-20,g=d.height,j=d.width,l=0,m=0,n=c?"inline":"none",o={top:l,left:m,position:"relative",display:n},p=1;g>e||j>f?g/e>j/f?(p=e/g,o.left=(f-j*p)/2):(p=f/j,o.top=(e-g)/2,o.left=-(j-f)/2):(o.left=(f-j)/2,o.top=(e-g)/2),c||(o=a.mix(i(0,p),o)),b.css(o),h.get("contentEl").all(".album-loading").removeClass("album-loading"),c||b.fadeIn(),this.set("zoomFit",p),this.set("scale",p)}},show:function(a,b){var c=this.get("baseEl");this._show({target:c.all(a)[0]},b)},_show:function(b,c){var d=b.target,e=l(d).attr("data-original-url"),f=l(d).attr("data-download");e||(e=d.src),this._setEls();var g=l(d).attr("data-index");this.set("index",parseInt(g,10));var i=this.get("len"),j=h.getWinHeight();h.getWinWidth();var k={src:e,imgCls:"J_img",index:+g,len:i,h:j-74,desc:l(d).attr("data-desc")||"",download:f,title:this.get("title")},m=this.get("template").render(a.mix(k,this.get("datas")));h.set("bodyContent",m),h.show(),h.set("album-id",this.get("id"));var n=h.get("contentEl").all(".J_img"),o=this;n.data("loaded",!1),n.on("load",function(){n.data("loaded",!0),o._position(n),c&&c()})},next:function(){},go:function(a){a=parseInt(a,10);var b=this.get("imgList").length,c=this.get("index")+a;if(!(0>c||c>b-1)){this.get("baseEl");var d=this.get("imgList").item(c);this.fire("switch",{from:this.get("index"),to:c}),this.show(d,function(){h.fire("change:step")})}},_go:function(a){var b=l(a.el),c=b.hasClass("prev")?-1:1;this.go(c)}},{ATTRS:{baseEl:{setter:function(a){return l(a)}},imgList:{value:null},img:{value:".J_ImgDD"},len:{value:0},trigger:{value:"click"},title:{value:"\u67e5\u770b\u56fe\u7247"},index:{value:0},datas:{value:{prefix:"\u56fe\u7247\u8bf4\u660e"}},template:{value:m},id:{setter:function(){return a.guid()}},rotation:{value:0},scale:{value:1}}}),j},{requires:["node","base","overlay","anim","./album-tpl","xtemplate","./dialog","./rotate","./index.css"]});